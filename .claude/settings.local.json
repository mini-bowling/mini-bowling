{
  "permissions": {
    "allow": [
      "Bash(ls:*)",
      "Bash(git mv:*)",
      "Bash(head:*)",
      "Bash(python3 << 'EOF'\n# Append the replacement pairs to the migration script\n# Using a list of \\(old, new\\) tuples\n\nreplacements = []\n\n# Change 1a: include\nreplacements.append\\(\\(\n    '#include <AccelStepper.h>',\n    '#include <FastAccelStepper.h>'\n\\)\\)\n\n# Change 1b: global stepper declaration\nreplacements.append\\(\\(\n    '// Stepper\\\\nAccelStepper stepper\\(1, STEP_PIN, DIR_PIN\\);',\n    '// Stepper\\\\nFastAccelStepperEngine stepperEngine = FastAccelStepperEngine\\(\\);\\\\nFastAccelStepper *stepper = NULL;'\n\\)\\)\n\n# Change 1c: turretMoving global\nreplacements.append\\(\\(\n    'bool turretMoving = false;\\\\nlong turretTargetPos = 0;',\n    'long turretTargetPos = 0;'\n\\)\\)\n\n# Change 2: setup\\(\\) stepper init\nreplacements.append\\(\\(\n    \"  // Initialize stepper \\(but don't move\\)\\\\n  stepper.setMaxSpeed\\(TURRET_NORMAL_MAXSPEED\\);\\\\n  stepper.setAcceleration\\(TURRET_NORMAL_ACCEL\\);\\\\n#ifdef STEPPER_ENABLE_PIN\\\\n  stepper.setEnablePin\\(STEPPER_ENABLE_PIN\\);\\\\n  stepper.setPinsInverted\\(false, false, true\\);  // Enable pin is active LOW\\\\n  stepper.enableOutputs\\(\\);\\\\n#endif\",\n    \"  // Initialize stepper \\(but don't move\\)\\\\n  stepperEngine.init\\(\\);\\\\n  stepper = stepperEngine.stepperConnectToPin\\(STEP_PIN\\);\\\\n  stepper->setDirectionPin\\(DIR_PIN\\);\\\\n  stepper->setSpeedInHz\\(\\(uint32_t\\)TURRET_NORMAL_MAXSPEED\\);\\\\n  stepper->setAcceleration\\(\\(uint32_t\\)TURRET_NORMAL_ACCEL\\);\\\\n#ifdef STEPPER_ENABLE_PIN\\\\n  stepper->setEnablePin\\(STEPPER_ENABLE_PIN, false\\);  // false = active LOW\\\\n  stepper->enableOutputs\\(\\);\\\\n#endif\"\n\\)\\)\n\n# Change 3a: remove stepper.run\\(\\)\nreplacements.append\\(\\(\n    '  stepper.run\\(\\);\\\\n  updateSweepTween\\(\\);',\n    '  updateSweepTween\\(\\);'\n\\)\\)\n\n# Change 3b: completion block\nreplacements.append\\(\\(\n    '  // Check turret movement complete \\(suppress during automated sequences\\)\\\\n  if \\(turretMoving && stepper.distanceToGo\\(\\) == 0\\) {\\\\n    turretMoving = false;\\\\n    if \\(!turretLoadActive\\) {\\\\n      Serial.println\\(F\\(\">> Movement complete\"\\)\\);\\\\n    }\\\\n  }',\n    '  // Check turret movement complete \\(suppress during automated sequences\\)\\\\n  static bool prevTurretRunning = false;\\\\n  bool nowRunning = stepper->isRunning\\(\\);\\\\n  if \\(prevTurretRunning && !nowRunning && !turretLoadActive\\) {\\\\n    Serial.println\\(F\\(\">> Movement complete\"\\)\\);\\\\n  }\\\\n  prevTurretRunning = nowRunning;'\n\\)\\)\n\n# Change 4: turretGoTo\\(\\)\nreplacements.append\\(\\(\n    'void turretGoTo\\(long pos\\) {\\\\n#ifdef STEPPER_ENABLE_PIN\\\\n  stepper.enableOutputs\\(\\);\\\\n#endif\\\\n  if \\(turretTargetPos != pos\\) {\\\\n    turretTargetPos = pos;\\\\n    stepper.moveTo\\(turretTargetPos\\);\\\\n    turretMoving = true;\\\\n  }\\\\n}',\n    'void turretGoTo\\(long pos\\) {\\\\n#ifdef STEPPER_ENABLE_PIN\\\\n  stepper->enableOutputs\\(\\);\\\\n#endif\\\\n  if \\(turretTargetPos != pos\\) {\\\\n    turretTargetPos = pos;\\\\n    stepper->moveTo\\(turretTargetPos\\);\\\\n  }\\\\n}'\n\\)\\)\n\n# Change 5: turretMoveRelative\\(\\)\nreplacements.append\\(\\(\n    'void turretMoveRelative\\(long steps\\) {\\\\n  long newPos = stepper.currentPosition\\(\\) + steps;\\\\n  turretGoTo\\(newPos\\);\\\\n}',\n    'void turretMoveRelative\\(long steps\\) {\\\\n  long newPos = stepper->getCurrentPosition\\(\\) + steps;\\\\n  turretGoTo\\(newPos\\);\\\\n}'\n\\)\\)\n\n# Change 6a: stopAllSequences\\(\\) emergency stop\nreplacements.append\\(\\(\n    '  stepper.stop\\(\\);\\\\n  stepper.setCurrentPosition\\(stepper.currentPosition\\(\\)\\);\\\\n  turretMoving = false;\\\\n  seqPrompt = SEQPROMPT_NONE;',\n    '  stepper->forceStop\\(\\);\\\\n  seqPrompt = SEQPROMPT_NONE;'\n\\)\\)\n\n# Change 6b: turret menu stop/x\nreplacements.append\\(\\(\n    '    stepper.stop\\(\\);\\\\n    stepper.setCurrentPosition\\(stepper.currentPosition\\(\\)\\);\\\\n    turretMoving = false;\\\\n    homingActive = false;\\\\n    homingPhase = HOME_IDLE;',\n    '    stepper->forceStop\\(\\);\\\\n    homingActive = false;\\\\n    homingPhase = HOME_IDLE;'\n\\)\\)\n\n# Change 6c: disengage\nreplacements.append\\(\\(\n    '    stepper.stop\\(\\);\\\\n    stepper.disableOutputs\\(\\);\\\\n    turretMoving = false;\\\\n    homingActive = false;\\\\n    homingPhase = HOME_IDLE;',\n    '    stepper->forceStop\\(\\);\\\\n    stepper->disableOutputs\\(\\);\\\\n    homingActive = false;\\\\n    homingPhase = HOME_IDLE;'\n\\)\\)\n\n# Change 7: HOME_CHECK_INITIAL_SENSOR stop block\nreplacements.append\\(\\(\n    '        stepper.stop\\(\\);\\\\n        stepper.setCurrentPosition\\(stepper.currentPosition\\(\\)\\);\\\\n        turretMoving = false;\\\\n        Serial.println\\(F\\(\"   Sensor cleared - turret was at CCW stop. Advancing CW to find home...\"\\)\\);\\\\n        homingPhase = HOME_ADVANCE_TO_SWITCH;\\\\n        turretGoTo\\(stepper.currentPosition\\(\\) + 3000\\); // Large move; FSM stops on sensor detect\\\\n      } else if \\(stepper.distanceToGo\\(\\) == 0\\) {',\n    '        stepper->forceStop\\(\\);\\\\n        Serial.println\\(F\\(\"   Sensor cleared - turret was at CCW stop. Advancing CW to find home...\"\\)\\);\\\\n        homingPhase = HOME_ADVANCE_TO_SWITCH;\\\\n        turretGoTo\\(stepper->getCurrentPosition\\(\\) + 3000\\); // Large move; FSM stops on sensor detect\\\\n      } else if \\(!stepper->isRunning\\(\\)\\) {'\n\\)\\)\n\n# HOME_CHECK_INITIAL_SENSOR nudge + HOME_PREP_MOVE_TO_SLOT1 block\nreplacements.append\\(\\(\n    '        homingPhase = HOME_BACKOFF;\\\\n        turretGoTo\\(stepper.currentPosition\\(\\) - 150\\);\\\\n      }\\\\n      break;\\\\n\\\\n    case HOME_PREP_MOVE_TO_SLOT1:\\\\n      if \\(hallState == LOW\\) {\\\\n        // Hall sensor triggered during prep move - stop and back off\\\\n        stepper.stop\\(\\);\\\\n        stepper.setCurrentPosition\\(stepper.currentPosition\\(\\)\\);\\\\n        turretMoving = false;\\\\n        Serial.println\\(F\\(\">> Magnet found during prep! Backing off...\"\\)\\);\\\\n        homingPhase = HOME_BACKOFF;\\\\n        turretGoTo\\(stepper.currentPosition\\(\\) - 150\\);\\\\n      }\\\\n      else if \\(stepper.distanceToGo\\(\\) == 0\\) {',\n    '        homingPhase = HOME_BACKOFF;\\\\n        turretGoTo\\(stepper->getCurrentPosition\\(\\) - 150\\);\\\\n      }\\\\n      break;\\\\n\\\\n    case HOME_PREP_MOVE_TO_SLOT1:\\\\n      if \\(hallState == LOW\\) {\\\\n        // Hall sensor triggered during prep move - stop and back off\\\\n        stepper->forceStop\\(\\);\\\\n        Serial.println\\(F\\(\">> Magnet found during prep! Backing off...\"\\)\\);\\\\n        homingPhase = HOME_BACKOFF;\\\\n        turretGoTo\\(stepper->getCurrentPosition\\(\\) - 150\\);\\\\n      }\\\\n      else if \\(!stepper->isRunning\\(\\)\\) {'\n\\)\\)\n\n# HOME_ADVANCE_TO_SWITCH\nreplacements.append\\(\\(\n    '    case HOME_ADVANCE_TO_SWITCH:\\\\n      if \\(hallState == HIGH\\) {\\\\n        if \\(stepper.distanceToGo\\(\\) == 0\\) {\\\\n          turretGoTo\\(stepper.currentPosition\\(\\) + 10\\);\\\\n        }\\\\n      } else {\\\\n        Serial.println\\(F\\(\">> Magnet found! Backing off...\"\\)\\);\\\\n        homingPhase = HOME_BACKOFF;\\\\n        turretGoTo\\(stepper.currentPosition\\(\\) - 150\\);',\n    '    case HOME_ADVANCE_TO_SWITCH:\\\\n      if \\(hallState == HIGH\\) {\\\\n        if \\(!stepper->isRunning\\(\\)\\) {\\\\n          turretGoTo\\(stepper->getCurrentPosition\\(\\) + 10\\);\\\\n        }\\\\n      } else {\\\\n        Serial.println\\(F\\(\">> Magnet found! Backing off...\"\\)\\);\\\\n        homingPhase = HOME_BACKOFF;\\\\n        turretGoTo\\(stepper->getCurrentPosition\\(\\) - 150\\);'\n\\)\\)\n\n# HOME_BACKOFF\nreplacements.append\\(\\(\n    '    case HOME_BACKOFF:\\\\n      if \\(stepper.distanceToGo\\(\\) == 0\\) {\\\\n        Serial.println\\(F\\(\">> Creeping to find precise position...\"\\)\\);\\\\n        stepper.setMaxSpeed\\(100\\);\\\\n        homingPhase = HOME_CREEP_TO_SWITCH;\\\\n      }',\n    '    case HOME_BACKOFF:\\\\n      if \\(!stepper->isRunning\\(\\)\\) {\\\\n        Serial.println\\(F\\(\">> Creeping to find precise position...\"\\)\\);\\\\n        stepper->setSpeedInHz\\(\\(uint32_t\\)100\\);\\\\n        homingPhase = HOME_CREEP_TO_SWITCH;\\\\n      }'\n\\)\\)\n\n# HOME_CREEP_TO_SWITCH\nreplacements.append\\(\\(\n    '    case HOME_CREEP_TO_SWITCH:\\\\n      if \\(hallState == HIGH\\) {\\\\n        if \\(stepper.distanceToGo\\(\\) == 0\\) {\\\\n          turretGoTo\\(stepper.currentPosition\\(\\) + 2\\);\\\\n        }\\\\n      } else {\\\\n        Serial.println\\(F\\(\">> Precise position found!\"\\)\\);\\\\n        stepper.setCurrentPosition\\(TURRET_HOME_ADJUSTER\\);\\\\n        stepper.setMaxSpeed\\(500\\);\\\\n        stepper.setAcceleration\\(3000\\);\\\\n        turretGoTo\\(PinPositions[1]\\);',\n    '    case HOME_CREEP_TO_SWITCH:\\\\n      if \\(hallState == HIGH\\) {\\\\n        if \\(!stepper->isRunning\\(\\)\\) {\\\\n          turretGoTo\\(stepper->getCurrentPosition\\(\\) + 2\\);\\\\n        }\\\\n      } else {\\\\n        Serial.println\\(F\\(\">> Precise position found!\"\\)\\);\\\\n        stepper->forceStop\\(\\);\\\\n        stepper->setCurrentPosition\\(TURRET_HOME_ADJUSTER\\);\\\\n        stepper->setSpeedInHz\\(\\(uint32_t\\)500\\);\\\\n        stepper->setAcceleration\\(\\(uint32_t\\)3000\\);\\\\n        turretGoTo\\(PinPositions[1]\\);'\n\\)\\)\n\n# HOME_SETZERO_AND_MOVE_SLOT1\nreplacements.append\\(\\(\n    '    case HOME_SETZERO_AND_MOVE_SLOT1:\\\\n      if \\(stepper.distanceToGo\\(\\) == 0\\) {\\\\n        homingPhase = HOME_DONE;\\\\n      }',\n    '    case HOME_SETZERO_AND_MOVE_SLOT1:\\\\n      if \\(!stepper->isRunning\\(\\)\\) {\\\\n        homingPhase = HOME_DONE;\\\\n      }'\n\\)\\)\n\n# HOME_DONE restore normal speed\nreplacements.append\\(\\(\n    '      stepper.setMaxSpeed\\(TURRET_NORMAL_MAXSPEED\\);\\\\n      stepper.setAcceleration\\(TURRET_NORMAL_ACCEL\\);\\\\n      Serial.println\\(F\\(\">> HOMING COMPLETE\"\\)\\);\\\\n      Serial.print\\(F\\(\"   Position: \"\\)\\);\\\\n      Serial.println\\(stepper.currentPosition\\(\\)\\);',\n    '      stepper->setSpeedInHz\\(\\(uint32_t\\)TURRET_NORMAL_MAXSPEED\\);\\\\n      stepper->setAcceleration\\(\\(uint32_t\\)TURRET_NORMAL_ACCEL\\);\\\\n      Serial.println\\(F\\(\">> HOMING COMPLETE\"\\)\\);\\\\n      Serial.print\\(F\\(\"   Position: \"\\)\\);\\\\n      Serial.println\\(stepper->getCurrentPosition\\(\\)\\);'\n\\)\\)\n\n# Change 9a: startTurretHome\\(\\) speed settings\nreplacements.append\\(\\(\n    '  stepper.setAcceleration\\(3000\\);\\\\n  stepper.setMaxSpeed\\(500\\);\\\\n\\\\n  if \\(digitalRead\\(HALL_EFFECT_PIN\\) == LOW\\) {',\n    '  stepper->setAcceleration\\(\\(uint32_t\\)3000\\);\\\\n  stepper->setSpeedInHz\\(\\(uint32_t\\)500\\);\\\\n\\\\n  if \\(digitalRead\\(HALL_EFFECT_PIN\\) == LOW\\) {'\n\\)\\)\n\n# startTurretHome nudge and prep\nreplacements.append\\(\\(\n    '    turretGoTo\\(stepper.currentPosition\\(\\) + 100\\);\\\\n  } else {\\\\n    homingPhase = HOME_PREP_MOVE_TO_SLOT1;\\\\n    turretGoTo\\(PinPositions[1]\\);',\n    '    turretGoTo\\(stepper->getCurrentPosition\\(\\) + 100\\);\\\\n  } else {\\\\n    homingPhase = HOME_PREP_MOVE_TO_SLOT1;\\\\n    turretGoTo\\(PinPositions[1]\\);'\n\\)\\)\n\n# Change 9b: slot 0 spring-safe\nreplacements.append\\(\\(\n    \"    stepper.setMaxSpeed\\(TURRET_SPRING_MAXSPEED\\);\\\\n    stepper.setAcceleration\\(TURRET_SPRING_ACCEL\\);\\\\n    turretGoTo\\(releasePos\\);\\\\n  }\\\\n  else if \\(cmd.length\\(\\) == 1 && cmd.charAt\\(0\\) >= '1' && cmd.charAt\\(0\\) <= '9'\\) {\",\n    \"    stepper->setSpeedInHz\\(\\(uint32_t\\)TURRET_SPRING_MAXSPEED\\);\\\\n    stepper->setAcceleration\\(\\(uint32_t\\)TURRET_SPRING_ACCEL\\);\\\\n    turretGoTo\\(releasePos\\);\\\\n  }\\\\n  else if \\(cmd.length\\(\\) == 1 && cmd.charAt\\(0\\) >= '1' && cmd.charAt\\(0\\) <= '9'\\) {\"\n\\)\\)\n\n# Turret menu slots 1-9\nreplacements.append\\(\\(\n    '    stepper.setMaxSpeed\\(TURRET_NORMAL_MAXSPEED\\);\\\\n    stepper.setAcceleration\\(TURRET_NORMAL_ACCEL\\);\\\\n    turretGoTo\\(PinPositions[slot]\\);',\n    '    stepper->setSpeedInHz\\(\\(uint32_t\\)TURRET_NORMAL_MAXSPEED\\);\\\\n    stepper->setAcceleration\\(\\(uint32_t\\)TURRET_NORMAL_ACCEL\\);\\\\n    turretGoTo\\(PinPositions[slot]\\);'\n\\)\\)\n\n# Change 10: status command\nreplacements.append\\(\\(\n    '    Serial.println\\(stepper.currentPosition\\(\\)\\);\\\\n    Serial.print\\(F\\(\"Target: \"\\)\\);\\\\n    Serial.println\\(turretTargetPos\\);\\\\n    Serial.print\\(F\\(\"Moving: \"\\)\\);\\\\n    Serial.println\\(turretMoving ? \"YES\" : \"NO\"\\);',\n    '    Serial.println\\(stepper->getCurrentPosition\\(\\)\\);\\\\n    Serial.print\\(F\\(\"Target: \"\\)\\);\\\\n    Serial.println\\(turretTargetPos\\);\\\\n    Serial.print\\(F\\(\"Moving: \"\\)\\);\\\\n    Serial.println\\(stepper->isRunning\\(\\) ? \"YES\" : \"NO\"\\);'\n\\)\\)\n\n# Change 8: zero command\nreplacements.append\\(\\(\n    '    stepper.setCurrentPosition\\(0\\);\\\\n    turretTargetPos = 0;\\\\n    Serial.println\\(F\\(\">> Position zeroed\"\\)\\);',\n    '    stepper->forceStop\\(\\);\\\\n    stepper->setCurrentPosition\\(0\\);\\\\n    turretTargetPos = 0;\\\\n    Serial.println\\(F\\(\">> Position zeroed\"\\)\\);'\n\\)\\)\n\n# Change 11: TLOAD_MOVE_TO_SLOT1\nreplacements.append\\(\\(\n    '    case TLOAD_MOVE_TO_SLOT1:\\\\n      if \\(!turretMoving\\) {',\n    '    case TLOAD_MOVE_TO_SLOT1:\\\\n      if \\(!stepper->isRunning\\(\\)\\) {'\n\\)\\)\n\n# TLOAD_ADVANCING\nreplacements.append\\(\\(\n    '    case TLOAD_ADVANCING:\\\\n      if \\(!turretMoving\\) {',\n    '    case TLOAD_ADVANCING:\\\\n      if \\(!stepper->isRunning\\(\\)\\) {'\n\\)\\)\n\n# TLOAD_MOVE_RELEASE\nreplacements.append\\(\\(\n    '    case TLOAD_MOVE_RELEASE:\\\\n      if \\(!turretMoving\\) {',\n    '    case TLOAD_MOVE_RELEASE:\\\\n      if \\(!stepper->isRunning\\(\\)\\) {'\n\\)\\)\n\n# TLOAD_HOMING normal speed slot 1\nreplacements.append\\(\\(\n    '        stepper.setMaxSpeed\\(TURRET_NORMAL_MAXSPEED\\);\\\\n        stepper.setAcceleration\\(TURRET_NORMAL_ACCEL\\);\\\\n        turretGoTo\\(PinPositions[tlNowCatching]\\);\\\\n        turretLoadPhase = TLOAD_MOVE_TO_SLOT1;',\n    '        stepper->setSpeedInHz\\(\\(uint32_t\\)TURRET_NORMAL_MAXSPEED\\);\\\\n        stepper->setAcceleration\\(\\(uint32_t\\)TURRET_NORMAL_ACCEL\\);\\\\n        turretGoTo\\(PinPositions[tlNowCatching]\\);\\\\n        turretLoadPhase = TLOAD_MOVE_TO_SLOT1;'\n\\)\\)\n\n# TLOAD_WAIT_CATCH advancing\nreplacements.append\\(\\(\n    '        stepper.setMaxSpeed\\(TURRET_NORMAL_MAXSPEED\\);\\\\n        stepper.setAcceleration\\(TURRET_NORMAL_ACCEL\\);\\\\n        turretGoTo\\(PinPositions[tlNowCatching]\\);\\\\n        turretLoadPhase = TLOAD_ADVANCING;',\n    '        stepper->setSpeedInHz\\(\\(uint32_t\\)TURRET_NORMAL_MAXSPEED\\);\\\\n        stepper->setAcceleration\\(\\(uint32_t\\)TURRET_NORMAL_ACCEL\\);\\\\n        turretGoTo\\(PinPositions[tlNowCatching]\\);\\\\n        turretLoadPhase = TLOAD_ADVANCING;'\n\\)\\)\n\n# TLOAD_WAIT_TENTH spring-safe\nreplacements.append\\(\\(\n    '        stepper.setMaxSpeed\\(TURRET_SPRING_MAXSPEED\\);\\\\n        stepper.setAcceleration\\(TURRET_SPRING_ACCEL\\);\\\\n        turretGoTo\\(releasePos\\);\\\\n        turretLoadPhase = TLOAD_MOVE_RELEASE;',\n    '        stepper->setSpeedInHz\\(\\(uint32_t\\)TURRET_SPRING_MAXSPEED\\);\\\\n        stepper->setAcceleration\\(\\(uint32_t\\)TURRET_SPRING_ACCEL\\);\\\\n        turretGoTo\\(releasePos\\);\\\\n        turretLoadPhase = TLOAD_MOVE_RELEASE;'\n\\)\\)\n\n# TLOAD_RELEASE_DWELL re-home\nreplacements.append\\(\\(\n    '        stepper.setMaxSpeed\\(TURRET_NORMAL_MAXSPEED\\);\\\\n        stepper.setAcceleration\\(TURRET_NORMAL_ACCEL\\);\\\\n        startTurretHome\\(\\);',\n    '        stepper->setSpeedInHz\\(\\(uint32_t\\)TURRET_NORMAL_MAXSPEED\\);\\\\n        stepper->setAcceleration\\(\\(uint32_t\\)TURRET_NORMAL_ACCEL\\);\\\\n        startTurretHome\\(\\);'\n\\)\\)\n\nimport pickle\nwith open\\('/tmp/replacements.pkl', 'wb'\\) as f:\n    pickle.dump\\(replacements, f\\)\nprint\\(f\"Saved {len\\(replacements\\)} replacement pairs\"\\)\nEOF)",
      "WebSearch"
    ]
  }
}
